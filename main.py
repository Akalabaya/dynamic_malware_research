import os
import sys
from sklearn import preprocessing
import pandas as pd
from analyze import *
import pickle
file = open(sys.argv[1],"r").readlines()

i = 0
pred_array = []
for x in file:
    if i < 449 and not "Executing" in x:
        api = x.split("(")[0]
        pred_array.append(api)
        i += 1
leftover = 449 - len(pred_array)
a = 0
while a < leftover:
    pred_array.append("nan")
    a+=1

d = pickle.load(open("models/featuretoken.pkl","rb"))
clf = pickle.load(open("models/predictlayer1.pkl","rb"))
p = []
for x in pred_array:
    try:
        p.append(d[x])
    except:
        p.append(1)

api_score = int(clf.predict_proba([p])[0][1]*100)
analysis_path = os.path.abspath(os.path.join(sys.argv[1], os.pardir))+"/"+"Analysis.TXT"
ana_score = check(analysis_path) * 40/100


if int(api_score+ana_score) > 50:
   print("Malware")
   print("Confidence",":",int(api_score+ana_score),"%")
elif int(api_score+ana_score) < 50:
   print("Not malware")
   print("Confidence",":",100 - int(api_score+ana_score),"%")
else:
    if api_score > 10:
        print("Malware")
        print("Confidence",":",100-int(api_score+ana_score)+1,"%")
    else:
        print("Malware")
        print("Confidence",":",int(api_score+ana_score)-1,"%")